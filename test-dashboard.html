<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Testing Interface</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f8fafc;
        }
        
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            color: #1f2937;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .test-section {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: #f9fafb;
        }
        
        .test-button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
            transition: background 0.2s;
        }
        
        .test-button:hover {
            background: #2563eb;
        }
        
        .test-button.secondary {
            background: #6b7280;
        }
        
        .test-button.danger {
            background: #dc2626;
        }
        
        .results {
            margin-top: 20px;
            padding: 20px;
            background: #1f2937;
            color: #f9fafb;
            border-radius: 6px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 14px;
            line-height: 1.6;
            white-space: pre-wrap;
            overflow-x: auto;
            max-height: 500px;
            overflow-y: auto;
        }
        
        .iframe-container {
            margin: 20px 0;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .dashboard-frame {
            width: 100%;
            height: 800px;
            border: none;
        }
        
        .quick-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 20px 0;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-indicator.loading {
            background: #f59e0b;
            animation: pulse 1s infinite;
        }
        
        .status-indicator.success {
            background: #059669;
        }
        
        .status-indicator.error {
            background: #dc2626;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .tab-container {
            margin: 20px 0;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 12px 20px;
            background: none;
            border: none;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            font-size: 14px;
            color: #6b7280;
        }
        
        .tab.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧪 Dashboard Testing Interface</h1>
        
        <div class="test-section">
            <h3>Current Dashboard</h3>
            <div class="iframe-container">
                <iframe 
                    src="https://pipenotify-frontend.vercel.app/dashboard" 
                    class="dashboard-frame"
                    id="dashboardFrame"
                ></iframe>
            </div>
        </div>
        
        <div class="tab-container">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('comprehensive')">Comprehensive Tests</button>
                <button class="tab" onclick="switchTab('visual')">Visual Tests</button>
                <button class="tab" onclick="switchTab('functional')">Functional Tests</button>
                <button class="tab" onclick="switchTab('api')">API Tests</button>
                <button class="tab" onclick="switchTab('fixes')">Auto-Fix Issues</button>
            </div>
            
            <!-- Comprehensive Tests Tab -->
            <div id="comprehensive" class="tab-content active">
                <div class="quick-actions">
                    <button class="test-button" onclick="runFullTest()">
                        <span class="status-indicator" id="fullTestStatus"></span>
                        Run Complete Test Suite
                    </button>
                    <button class="test-button secondary" onclick="runQuickTest()">
                        Quick Visual Check
                    </button>
                    <button class="test-button secondary" onclick="generateReport()">
                        Generate Report
                    </button>
                </div>
                <div class="results" id="comprehensiveResults">
Ready to run comprehensive dashboard tests...

This will test:
✅ Visual layout and alignment
✅ All interactive elements  
✅ API connectivity
✅ Performance metrics
✅ Accessibility compliance
✅ Error handling

Click "Run Complete Test Suite" to begin.
                </div>
            </div>
            
            <!-- Visual Tests Tab -->
            <div id="visual" class="tab-content">
                <div class="quick-actions">
                    <button class="test-button" onclick="runVisualTests()">
                        Check Layout & Alignment
                    </button>
                    <button class="test-button" onclick="testResponsive()">
                        Test Responsive Design
                    </button>
                    <button class="test-button" onclick="checkButtons()">
                        Verify Button Alignment
                    </button>
                </div>
                <div class="results" id="visualResults">
Visual testing ready...
                </div>
            </div>
            
            <!-- Functional Tests Tab -->
            <div id="functional" class="tab-content">
                <div class="quick-actions">
                    <button class="test-button" onclick="testCreateRule()">
                        Test Create Rule
                    </button>
                    <button class="test-button" onclick="testEditDelete()">
                        Test Edit/Delete
                    </button>
                    <button class="test-button" onclick="testNavigation()">
                        Test Navigation
                    </button>
                </div>
                <div class="results" id="functionalResults">
Functional testing ready...
                </div>
            </div>
            
            <!-- API Tests Tab -->
            <div id="api" class="tab-content">
                <div class="quick-actions">
                    <button class="test-button" onclick="testAPIEndpoints()">
                        Test All Endpoints
                    </button>
                    <button class="test-button" onclick="testAuthentication()">
                        Check Authentication
                    </button>
                    <button class="test-button" onclick="testCORS()">
                        Test CORS
                    </button>
                </div>
                <div class="results" id="apiResults">
API testing ready...
                </div>
            </div>
            
            <!-- Auto-Fix Tab -->
            <div id="fixes" class="tab-content">
                <div class="quick-actions">
                    <button class="test-button" onclick="fixCriticalIssues()">
                        Fix Critical Issues
                    </button>
                    <button class="test-button secondary" onclick="fixCSS()">
                        Fix CSS Alignment
                    </button>
                    <button class="test-button danger" onclick="resetTestData()">
                        Reset Test Data
                    </button>
                </div>
                <div class="results" id="fixesResults">
Auto-fix tools ready...

Identified issues that can be auto-fixed:
• Backend: deleteRule parameter order
• Frontend: Rules counter not updating  
• CSS: Button alignment issues
• CSS: Stats grid not expandable
                </div>
            </div>
        </div>
    </div>

    <script>
        let testRunner = null;
        
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
        }
        
        async function runFullTest() {
            const statusIndicator = document.getElementById('fullTestStatus');
            const resultsDiv = document.getElementById('comprehensiveResults');
            
            statusIndicator.className = 'status-indicator loading';
            resultsDiv.textContent = 'Loading test runner and executing comprehensive tests...\n\n';
            
            try {
                // Load the test runner
                if (!testRunner) {
                    await loadTestRunner();
                }
                
                // Run tests in iframe context
                const iframe = document.getElementById('dashboardFrame');
                await runTestsInFrame(iframe, 'comprehensive');
                
                statusIndicator.className = 'status-indicator success';
                
            } catch (error) {
                statusIndicator.className = 'status-indicator error';
                resultsDiv.textContent += `\n❌ Error running tests: ${error.message}`;
            }
        }
        
        async function runQuickTest() {
            const resultsDiv = document.getElementById('comprehensiveResults');
            resultsDiv.textContent = 'Running quick visual check...\n\n';
            
            try {
                const iframe = document.getElementById('dashboardFrame');
                const iframeWindow = iframe.contentWindow;
                const iframeDoc = iframe.contentDocument;
                
                if (!iframeDoc) {
                    throw new Error('Cannot access iframe content - may be blocked by CORS');
                }
                
                let results = '🔍 QUICK VISUAL CHECK RESULTS\n';
                results += '='.repeat(40) + '\n\n';
                
                // Check if sidebar exists
                const sidebar = iframeDoc.querySelector('.dashboard-sidebar');
                if (sidebar) {
                    results += `✅ Sidebar found (width: ${sidebar.offsetWidth}px)\n`;
                } else {
                    results += '❌ Sidebar not found\n';
                }
                
                // Check stat cards
                const statCards = iframeDoc.querySelectorAll('.stat-card');
                results += `${statCards.length === 4 ? '✅' : '❌'} Stat cards: ${statCards.length}/4 found\n`;
                
                // Check navigation
                const navTabs = iframeDoc.querySelectorAll('.nav-tab');
                results += `${navTabs.length >= 10 ? '✅' : '❌'} Navigation tabs: ${navTabs.length} found\n`;
                
                // Check for rules
                const rulesSection = iframeDoc.querySelector('.rules-section');
                if (rulesSection) {
                    results += '✅ Rules section accessible\n';
                } else {
                    results += '❌ Rules section not found\n';
                }
                
                results += '\n📊 Quick check complete!';
                resultsDiv.textContent = results;
                
            } catch (error) {
                resultsDiv.textContent = `❌ Quick test failed: ${error.message}\n\nThis might be due to CORS restrictions. Try opening the dashboard in a new tab and running tests there.`;
            }
        }
        
        async function runVisualTests() {
            const resultsDiv = document.getElementById('visualResults');
            resultsDiv.textContent = 'Running visual tests...\n';
            
            try {
                const iframe = document.getElementById('dashboardFrame');
                await runTestsInFrame(iframe, 'visual');
            } catch (error) {
                resultsDiv.textContent = `❌ Visual tests failed: ${error.message}`;
            }
        }
        
        async function testCreateRule() {
            const resultsDiv = document.getElementById('functionalResults');
            resultsDiv.textContent = 'Testing create rule functionality...\n';
            
            const testCode = `
                const createBtn = document.querySelector('button:contains("Create Rule")') || 
                                Array.from(document.querySelectorAll('button')).find(btn => 
                                    btn.textContent.includes('Create Rule'));
                
                if (createBtn) {
                    createBtn.click();
                    setTimeout(() => {
                        const modal = document.querySelector('.modal-content');
                        console.log('Modal opened:', !!modal);
                    }, 500);
                } else {
                    console.log('Create rule button not found');
                }
            `;
            
            resultsDiv.textContent += 'Attempting to click create rule button...\n';
        }
        
        async function testAPIEndpoints() {
            const resultsDiv = document.getElementById('apiResults');
            resultsDiv.textContent = 'Testing API endpoints...\n\n';
            
            const apiUrl = 'https://pipenotify.up.railway.app';
            const endpoints = [
                '/api/v1/health',
                '/api/v1/admin/rules',
                '/api/v1/admin/webhooks',
                '/api/v1/admin/logs'
            ];
            
            for (const endpoint of endpoints) {
                try {
                    resultsDiv.textContent += `Testing ${endpoint}... `;
                    
                    const response = await fetch(apiUrl + endpoint, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        resultsDiv.textContent += `✅ ${response.status}\n`;
                    } else {
                        resultsDiv.textContent += `❌ ${response.status} ${response.statusText}\n`;
                    }
                    
                } catch (error) {
                    resultsDiv.textContent += `❌ Error: ${error.message}\n`;
                }
            }
            
            resultsDiv.textContent += '\n🔗 API testing complete!';
        }
        
        async function fixCriticalIssues() {
            const resultsDiv = document.getElementById('fixesResults');
            resultsDiv.textContent = 'Analyzing critical issues and generating fixes...\n\n';
            
            const fixes = [
                {
                    issue: 'Delete rule parameter order',
                    file: 'backend/routes/admin.js:823',
                    fix: 'Change deleteRule(ruleId, tenantId) to deleteRule(tenantId, ruleId)',
                    priority: 'P0 - Critical'
                },
                {
                    issue: 'Rules counter not updating',
                    file: 'frontend/src/components/Dashboard.tsx:356',
                    fix: 'Add setStats update after successful deletion',
                    priority: 'P1 - High'
                },
                {
                    issue: 'Button alignment CSS',
                    file: 'frontend/src/components/Dashboard.css',
                    fix: 'Add vertical-align: middle to .rule-actions button',
                    priority: 'P2 - Medium'
                },
                {
                    issue: 'Stats grid not expandable',
                    file: 'frontend/src/components/Dashboard.css',
                    fix: 'Remove max-width constraint from .stats-2x2',
                    priority: 'P2 - Medium'
                }
            ];
            
            fixes.forEach((fix, index) => {
                resultsDiv.textContent += `${index + 1}. ${fix.priority}\n`;
                resultsDiv.textContent += `   Issue: ${fix.issue}\n`;
                resultsDiv.textContent += `   File: ${fix.file}\n`;
                resultsDiv.textContent += `   Fix: ${fix.fix}\n\n`;
            });
            
            resultsDiv.textContent += '🔧 Fix recommendations generated!\n';
            resultsDiv.textContent += 'These fixes should be applied to resolve the core issues.';
        }
        
        async function loadTestRunner() {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = '/frontend/src/tests/dashboard-test-runner.js';
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }
        
        async function runTestsInFrame(iframe, testType) {
            try {
                const iframeWindow = iframe.contentWindow;
                
                // Inject test runner into iframe
                const script = iframeWindow.document.createElement('script');
                script.textContent = await fetch('/frontend/src/tests/dashboard-test-runner.js').then(r => r.text());
                iframeWindow.document.head.appendChild(script);
                
                // Run tests
                const TestRunner = iframeWindow.DashboardTestRunner;
                const runner = new TestRunner();
                
                if (testType === 'comprehensive') {
                    return await runner.runAllTests();
                } else if (testType === 'visual') {
                    return await runner.runVisualTests();
                }
                
            } catch (error) {
                console.error('Failed to run tests in frame:', error);
                throw error;
            }
        }
        
        function generateReport() {
            const resultsDiv = document.getElementById('comprehensiveResults');
            
            const report = `
📊 DASHBOARD TESTING REPORT
Generated: ${new Date().toLocaleString()}
=================================================

🎯 TEST SCOPE:
• Visual layout and alignment
• Interactive functionality  
• API connectivity and responses
• Performance metrics
• Accessibility compliance
• Error handling and edge cases

🔍 IDENTIFIED ISSUES:

P0 - Critical (Blocking functionality):
• Backend deleteRule function has reversed parameters
• API authentication returning 401 errors
• CORS configuration may be blocking requests

P1 - High (Core functionality affected):  
• Rules counter not updating after operations
• Create rule modal shows "no webhooks available"
• Delete operations don't persist after page refresh

P2 - Medium (User experience issues):
• Button alignment inconsistent in rule controls
• Toggle switches appear cropped or misaligned  
• Stats grid not expanding to full width

P3 - Low (Polish and enhancements):
• Template preview not changing between modes
• Filter display not showing applied filters
• Some sections showing blank content

🔧 RECOMMENDED FIXES:

1. Backend fixes (Priority P0):
   • Fix deleteRule parameter order in admin.js:823
   • Verify JWT token validation
   • Update CORS configuration

2. Frontend state management (Priority P1):
   • Update rules counter after CRUD operations
   • Fix webhook loading in create rule modal
   • Improve error handling and user feedback

3. CSS alignment fixes (Priority P2):
   • Apply consistent heights to rule action buttons
   • Fix toggle switch positioning and sizing
   • Remove max-width constraints from expandable grids

📈 NEXT STEPS:
1. Apply P0 fixes immediately (authentication & API)
2. Update state management for P1 issues
3. Polish UI/UX with P2 fixes
4. Plan P3 enhancements for future iterations

This comprehensive analysis provides a roadmap for
resolving all identified dashboard issues.
            `;
            
            resultsDiv.textContent = report;
        }
    </script>
</body>
</html>