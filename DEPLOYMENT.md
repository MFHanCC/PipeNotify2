# Production Deployment Guide

Complete guide for deploying Pipenotify to Railway (backend) and Vercel (frontend) with CI/CD.

## Overview
- **Backend**: Railway.app (Node.js + PostgreSQL + Redis)
- **Frontend**: Vercel.com (React SPA)
- **CI/CD**: GitHub Actions
- **Monitoring**: Sentry.io

## Prerequisites Checklist

### 1. Accounts Setup
- [ ] Railway account created and verified
- [ ] Vercel account created and verified
- [ ] Sentry.io account created and project set up
- [ ] GitHub repository with admin access
- [ ] Pipedrive developer account and app created

### 2. Local Tools Installation
```bash
# Install deployment CLIs
npm install -g @railway/cli
npm install -g vercel
npm install -g @sentry/cli

# Verify installations
railway --version
vercel --version
sentry-cli --version
```

## Step-by-Step Deployment

### Phase 1: Backend Deployment (Railway)

#### 1.1 Create Railway Project
```bash
railway login
cd backend
railway init
# Select "Empty Project" 
# Name: "pipenotify-backend"
```

#### 1.2 Add Services
In Railway Dashboard:
1. **Add PostgreSQL Service**
   - Click "Add Service" â†’ "Database" â†’ "PostgreSQL"
   - Note: DATABASE_URL will be auto-generated

2. **Add Redis Service**
   - Click "Add Service" â†’ "Database" â†’ "Redis" 
   - Note: REDIS_URL will be auto-generated

#### 1.3 Configure Environment Variables
In Railway Dashboard â†’ Environment Variables, add:

```bash
# Auto-generated (don't set manually)
DATABASE_URL=postgresql://...  # Auto-generated by PostgreSQL service
REDIS_URL=redis://...          # Auto-generated by Redis service

# Required manual configuration
NODE_ENV=production
PIPEDRIVE_API_TOKEN=your-pipedrive-api-token
SENTRY_DSN=https://your-sentry-dsn@sentry.io/project-id
JWT_SECRET=your-secure-random-jwt-secret-min-32-chars
WEBHOOK_SECRET=your-secure-random-webhook-secret

# Set after frontend deployment
FRONTEND_URL=https://your-app.vercel.app

# Optional performance tuning
RATE_LIMIT_WINDOW_MS=900000
RATE_LIMIT_MAX_REQUESTS=100
```

#### 1.4 Deploy Backend
```bash
cd backend
railway link [your-project-id]
railway up
```

#### 1.5 Run Database Migration
```bash
# Option 1: Using Railway shell
railway shell
cd db && ./migrate.sh production

# Option 2: Direct psql (if you have psql locally)
export DATABASE_URL="your-railway-database-url"
cd db && ./migrate.sh production
```

### Phase 2: Frontend Deployment (Vercel)

#### 2.1 Create Vercel Project
```bash
cd frontend
vercel login
vercel
# Follow prompts:
# - Link to existing project: No
# - Project name: pipenotify-frontend
# - Directory: ./
# - Override settings: No
```

#### 2.2 Configure Environment Variables
In Vercel Dashboard â†’ Settings â†’ Environment Variables:

```bash
# Required
REACT_APP_API_URL=https://your-backend.railway.app
REACT_APP_PIPEDRIVE_CLIENT_ID=your-pipedrive-oauth-client-id
REACT_APP_PIPEDRIVE_REDIRECT_URI=https://your-app.vercel.app/onboarding
REACT_APP_ENVIRONMENT=production

# Optional
REACT_APP_SENTRY_DSN=https://your-frontend-sentry-dsn@sentry.io/project-id
REACT_APP_ENABLE_DEBUG=false
REACT_APP_ENABLE_ANALYTICS=true
```

#### 2.3 Deploy Frontend
```bash
cd frontend
vercel --prod
```

### Phase 3: Update Cross-References

#### 3.1 Update Railway CORS
In Railway Dashboard â†’ Environment Variables:
```bash
FRONTEND_URL=https://your-app.vercel.app
```

#### 3.2 Update Pipedrive OAuth Settings
In Pipedrive Developer App settings:
- **Redirect URI**: `https://your-app.vercel.app/onboarding`
- **Webhook URL**: `https://your-backend.railway.app/api/v1/webhook/pipedrive`

### Phase 4: GitHub Actions CI/CD Setup

#### 4.1 GitHub Secrets Configuration
In GitHub Repository â†’ Settings â†’ Secrets and Variables â†’ Actions:

```bash
# Railway deployment
RAILWAY_TOKEN=your-railway-token
RAILWAY_PROJECT_ID=your-railway-project-id

# Vercel deployment  
VERCEL_TOKEN=your-vercel-token
VERCEL_ORG_ID=your-vercel-org-id
VERCEL_PROJECT_ID=your-vercel-project-id

# Sentry release tracking
SENTRY_AUTH_TOKEN=your-sentry-auth-token
SENTRY_ORG=your-sentry-org-slug
SENTRY_PROJECT=your-sentry-project-slug
```

#### 4.2 Get Required Tokens

**Railway Token:**
```bash
railway login
railway whoami  # Shows your info
# Go to Railway Dashboard â†’ Account Settings â†’ Tokens â†’ Create Token
```

**Vercel Token:**
```bash
vercel login
# Go to Vercel Dashboard â†’ Settings â†’ Tokens â†’ Create Token
```

**Vercel Project IDs:**
```bash
cd frontend
vercel link
cat .vercel/project.json  # Shows project and org IDs
```

**Sentry Token:**
- Go to Sentry.io â†’ Settings â†’ Auth Tokens â†’ Create New Token
- Scopes: `project:read`, `project:write`, `project:releases`

### Phase 5: Validation

#### 5.1 Health Checks
```bash
# Backend health
curl https://your-backend.railway.app/health

# Frontend accessibility
curl https://your-app.vercel.app

# API communication test
curl https://your-backend.railway.app/status
```

#### 5.2 End-to-End Test
1. Visit `https://your-app.vercel.app`
2. Click "Get Started" 
3. Verify OAuth redirect to Pipedrive
4. Test webhook endpoint with sample data
5. Check Sentry for error tracking

#### 5.3 Performance Verification
- [ ] Backend responds in <500ms
- [ ] Frontend loads in <3s
- [ ] Database queries execute successfully
- [ ] Redis connection established
- [ ] Webhook processing works
- [ ] Error tracking captures events

## Secret Management

### Environment Variables Summary

**Railway Backend:**
```env
DATABASE_URL=postgresql://...          # Auto-generated
REDIS_URL=redis://...                  # Auto-generated  
NODE_ENV=production
PIPEDRIVE_API_TOKEN=pd_...            # From Pipedrive app
SENTRY_DSN=https://...@sentry.io/...  # From Sentry project
FRONTEND_URL=https://....vercel.app   # After Vercel deployment
JWT_SECRET=min-32-char-random-string  # Generate securely
WEBHOOK_SECRET=random-string          # Generate securely
```

**Vercel Frontend:**
```env
REACT_APP_API_URL=https://...railway.app
REACT_APP_PIPEDRIVE_CLIENT_ID=...     # From Pipedrive app (public)
REACT_APP_PIPEDRIVE_REDIRECT_URI=https://...vercel.app/onboarding
REACT_APP_ENVIRONMENT=production
REACT_APP_SENTRY_DSN=https://...      # Frontend Sentry project
```

### Security Notes
- Railway DATABASE_URL and REDIS_URL are auto-generated securely
- JWT_SECRET should be min 32 characters, cryptographically random
- WEBHOOK_SECRET used for validating incoming Pipedrive webhooks
- PIPEDRIVE_API_TOKEN has read/write access to Pipedrive account
- Sentry DSNs are public but project-specific

## Troubleshooting

### Common Issues

**Railway Deployment Failed:**
```bash
railway logs --tail
railway status
```

**Vercel Build Failed:**
```bash
vercel logs
# Check environment variables in Vercel dashboard
```

**Database Connection Issues:**
```bash
railway shell
echo $DATABASE_URL
psql $DATABASE_URL -c "SELECT 1;"
```

**CORS Errors:**
- Verify FRONTEND_URL is set correctly in Railway
- Check browser network tab for exact error

**OAuth Flow Issues:**
- Verify redirect URIs match exactly
- Check Pipedrive app settings
- Verify client ID matches environment variable

### Support Resources
- Railway: https://docs.railway.app
- Vercel: https://vercel.com/docs  
- Sentry: https://docs.sentry.io
- Pipedrive: https://developers.pipedrive.com

## Post-Deployment Checklist

- [ ] Backend health endpoint returns 200
- [ ] Frontend loads without errors
- [ ] OAuth flow completes successfully
- [ ] Webhook processing works
- [ ] Database migration completed
- [ ] Redis connection established
- [ ] Sentry error tracking active
- [ ] CI/CD pipeline running
- [ ] Custom domains configured (optional)
- [ ] Monitoring alerts set up

ðŸŽ‰ **Deployment Complete!** Your Pipenotify integration is now live and ready for Pipedrive Marketplace submission.